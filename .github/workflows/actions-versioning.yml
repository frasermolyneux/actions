name: actions-versioning

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  tag-actions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Install Nerdbank.GitVersioning
        run: |
          dotnet tool install --global nbgv
          echo "PATH=$PATH:$HOME/.dotnet/tools" >> $GITHUB_ENV

      - name: Detect changed actions
        id: filter
        shell: bash
        run: |
          set -euo pipefail
          ACTIONS=(
            bicep-lint-code
            deploy-app-service
            deploy-function-app
            deploy-logic-app
            deploy-sql-database
            dotnet-ci
            dotnet-func-ci
            dotnet-web-ci
            dotnet-sdk-setup
            logic-app-ci
            nbgv-metadata
            publish-nuget-packages
            run-api-integration-tests
            terraform-apply
            terraform-destroy
            terraform-destroy-resources
            terraform-import
            terraform-plan
            terraform-plan-and-apply
            terraform-plan-readonly
            terraform-state-rm
          )

          BEFORE="${{ github.event.before }}"
          if [[ "$BEFORE" == "0000000000000000000000000000000000000000" ]]; then
            BEFORE=$(git rev-list --max-parents=0 HEAD)
          fi

          CHANGED=$(git diff --name-only "$BEFORE" "${{ github.sha }}")
          SELECTED=()
          for ACTION in "${ACTIONS[@]}"; do
            if echo "$CHANGED" | grep -q "^${ACTION}/"; then
              SELECTED+=("$ACTION")
            fi
          done

          printf 'actions=%s\n' "${SELECTED[*]}" >> "$GITHUB_OUTPUT"
          if [[ ${#SELECTED[@]} -eq 0 ]]; then
            echo "No action folders changed"
          else
            echo "Changed actions: ${SELECTED[*]}"
          fi

      - name: Tag updated actions
        if: steps.filter.outputs.actions != ''
        shell: bash
        env:
          CHANGED_ACTIONS: ${{ steps.filter.outputs.actions }}
        run: |
          set -euo pipefail
          export PATH="$PATH:$HOME/.dotnet/tools"
          for ACTION in $CHANGED_ACTIONS; do
            VERSION_INFO=$(nbgv get-version -p "$ACTION" -f json)
            MAJOR_MINOR=$(echo "$VERSION_INFO" | jq -r '.MajorMinorVersion')

            if [[ -z "$MAJOR_MINOR" || "$MAJOR_MINOR" == "null" ]]; then
              echo "Failed to resolve major/minor version for $ACTION"
              exit 1
            fi

            MAJOR="${MAJOR_MINOR%%.*}"
            if [[ -z "$MAJOR" ]]; then
              echo "Failed to resolve major version for $ACTION"
              exit 1
            fi

            PATCH_TAG_PREFIX="${ACTION}/v${MAJOR_MINOR}."
            CURRENT_PATCH_TAG=
            while IFS= read -r TAG; do
              if [[ "$TAG" == ${PATCH_TAG_PREFIX}* ]]; then
                PATCH="${TAG#${PATCH_TAG_PREFIX}}"
                if [[ "$PATCH" =~ ^[0-9]+$ ]]; then
                  CURRENT_PATCH_TAG="$TAG"
                  break
                fi
              fi
            done < <(git tag --points-at "${GITHUB_SHA}")

            if [[ -n "$CURRENT_PATCH_TAG" ]]; then
              VERSION="${CURRENT_PATCH_TAG#${ACTION}/v}"
              PATCH_TAG="$CURRENT_PATCH_TAG"
              echo "Commit already has $PATCH_TAG. Refreshing rolling tags."
            else
              LAST_PATCH=
              while IFS= read -r TAG; do
                PATCH="${TAG#${PATCH_TAG_PREFIX}}"
                if [[ "$PATCH" =~ ^[0-9]+$ ]]; then
                  if [[ -z "$LAST_PATCH" ]]; then
                    LAST_PATCH="$PATCH"
                  elif (( PATCH > LAST_PATCH )); then
                    LAST_PATCH="$PATCH"
                  fi
                fi
              done < <(git tag -l "${PATCH_TAG_PREFIX}*")

              if [[ -n "$LAST_PATCH" ]]; then
                NEXT_PATCH=$((LAST_PATCH + 1))
              else
                NEXT_PATCH=0
              fi

              VERSION="${MAJOR_MINOR}.${NEXT_PATCH}"
              PATCH_TAG="${ACTION}/v${VERSION}"
              git tag "$PATCH_TAG"
              git push origin "$PATCH_TAG"
              echo "Published $PATCH_TAG"
            fi

            MAJOR_TAG="${ACTION}/v${MAJOR}"
            MINOR_TAG="${ACTION}/v${MAJOR_MINOR}"

            git tag -f "$MAJOR_TAG"
            git push --force origin "$MAJOR_TAG"
            echo "Updated rolling tag $MAJOR_TAG"

            git tag -f "$MINOR_TAG"
            git push --force origin "$MINOR_TAG"
            echo "Updated rolling tag $MINOR_TAG"
          done
