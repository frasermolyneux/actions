name: reusable-code-quality

on:
  workflow_call:
    inputs:
      sonar-project-key:
        description: SonarCloud project key (e.g., frasermolyneux_portal-event-ingest).
        required: true
        type: string
      sonar-organization:
        description: SonarCloud organization key.
        required: false
        default: frasermolyneux
        type: string
      sonar-host-url:
        description: SonarCloud host URL.
        required: false
        default: https://sonarcloud.io
        type: string
      build-target:
        description: Selects the composite build action to run (dotnet-ci, dotnet-web-ci, or dotnet-func-ci).
        required: false
        default: dotnet-ci
        type: string
      dotnet-project:
        description: Required when build-target is dotnet-func-ci or dotnet-web-ci; the project name.
        required: false
        type: string
      publish-frameworks:
        description: Optional list of target frameworks to publish (only for dotnet-web-ci).
        required: false
        default: ""
        type: string
      nuget-artifact-name:
        description: Artifact name for NuGet packages (dotnet-web-ci only).
        required: false
        default: nuget-packages
        type: string
      dotnet-version:
        description: .NET SDK version(s) to install.
        required: false
        default: 9.0.x
        type: string
      src-folder:
        description: Folder that contains the .NET solution/projects.
        required: false
        default: src
        type: string
      use-framework-output-root:
        description: For dotnet-func-ci, upload the first target framework folder instead of bin/Release.
        required: false
        default: false
        type: boolean
      skip-sonar:
        description: Skip SonarCloud analysis (only run CodeQL).
        required: false
        default: false
        type: boolean
      skip-codeql:
        description: Skip CodeQL analysis (only run SonarCloud).
        required: false
        default: false
        type: boolean
    secrets:
      SONAR_TOKEN:
        description: SonarCloud token with analysis rights.
        required: false

permissions: {}

jobs:
  code-quality:
    permissions:
      contents: read
      actions: read
      security-events: write
    name: Code Quality
    runs-on: ubuntu-latest
    env:
      SONAR_CACHE_DIR: ~/.sonar/cache
      SONAR_SCANNER_DIR: $RUNNER_TEMP/sonar-scanner

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        if: ${{ inputs.skip-sonar != true }}
        uses: actions/setup-java@v5
        with:
          java-version: 17
          distribution: zulu

      - name: Cache SonarCloud packages
        if: ${{ inputs.skip-sonar != true }}
        uses: actions/cache@v5
        with:
          path: ${{ env.SONAR_CACHE_DIR }}
          key: ${{ runner.os }}-sonar-cache

      - name: Cache SonarCloud scanner
        if: ${{ inputs.skip-sonar != true }}
        id: cache-sonar-scanner
        uses: actions/cache@v5
        with:
          path: ${{ env.SONAR_SCANNER_DIR }}
          key: ${{ runner.os }}-sonar-scanner

      - name: Install SonarCloud scanner
        if: ${{ inputs.skip-sonar != true && steps.cache-sonar-scanner.outputs.cache-hit != 'true' }}
        shell: bash
        run: |
          mkdir -p "${{ env.SONAR_SCANNER_DIR }}"
          dotnet tool update dotnet-sonarscanner --tool-path "${{ env.SONAR_SCANNER_DIR }}"

      - name: Initialize CodeQL
        if: ${{ inputs.skip-codeql != true }}
        uses: github/codeql-action/init@v4
        with:
          languages: csharp

      - name: Validate project inputs
        if: inputs.build-target == 'dotnet-func-ci' || inputs.build-target == 'dotnet-web-ci'
        shell: bash
        run: |
          if [ -z "${{ inputs.dotnet-project }}" ]; then
            echo "dotnet-project is required when build-target is dotnet-func-ci or dotnet-web-ci" >&2
            exit 1
          fi

      - name: Begin SonarCloud analysis
        if: ${{ inputs.skip-sonar != true }}
        shell: bash
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          cd "${{ inputs.src-folder }}"
          "${{ env.SONAR_SCANNER_DIR }}/dotnet-sonarscanner" begin \
            /k:"${{ inputs.sonar-project-key }}" \
            /o:"${{ inputs.sonar-organization }}" \
            /d:sonar.token="$SONAR_TOKEN" \
            /d:sonar.host.url="${{ inputs.sonar-host-url }}"

      - name: Build and test (.NET)
        if: inputs.build-target == 'dotnet-ci'
        uses: frasermolyneux/actions/dotnet-ci@dotnet-ci/v1
        with:
          dotnet-version: ${{ inputs.dotnet-version }}
          src-folder: ${{ inputs.src-folder }}
          perform-checkout: 'false'

      - name: Build and publish (Web)
        if: inputs.build-target == 'dotnet-web-ci'
        uses: frasermolyneux/actions/dotnet-web-ci@dotnet-web-ci/v1
        with:
          dotnet-project: ${{ inputs.dotnet-project }}
          dotnet-version: ${{ inputs.dotnet-version }}
          publish-frameworks: ${{ inputs.publish-frameworks }}
          src-folder: ${{ inputs.src-folder }}
          nugetArtifactName: ${{ inputs.nuget-artifact-name }}
          perform-checkout: 'false'

      - name: Build and test (Function)
        if: inputs.build-target == 'dotnet-func-ci'
        uses: frasermolyneux/actions/dotnet-func-ci@dotnet-func-ci/v1
        with:
          dotnet-project: ${{ inputs.dotnet-project }}
          dotnet-version: ${{ inputs.dotnet-version }}
          src-folder: ${{ inputs.src-folder }}
          perform-checkout: 'false'
          use-framework-output-root: ${{ inputs.use-framework-output-root }}

      - name: End SonarCloud analysis
        if: ${{ inputs.skip-sonar != true && always() }}
        shell: bash
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          cd "${{ inputs.src-folder }}"
          "${{ env.SONAR_SCANNER_DIR }}/dotnet-sonarscanner" end /d:sonar.token="$SONAR_TOKEN"

      - name: Perform CodeQL analysis
        if: ${{ inputs.skip-codeql != true }}
        uses: github/codeql-action/analyze@v4
        with:
          category: /language:csharp
